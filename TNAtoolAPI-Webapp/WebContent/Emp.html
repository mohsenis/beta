<!DOCTYPE html>
<html>
<head>
	<!-- <meta charset="utf-8"> -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<title>Aggregated Employment Report</title>
	<link rel="stylesheet" href="js/lib/jstree-themes/default/style.min.css" />
	<script src="js/lib/jquery-1.11.1.min.js"></script>
	<script src="js/lib/jstree.min.js"></script>
	<script src="js/jQueryContent.js"></script>
	<script src="js/lib/jquery-ui.js"></script>
	<script src="js/lib/sorttable.js"></script>
	<script src="js/lib/slidebars.min.js"></script>
	<script src="js/lib/DataTables/js/jquery.dataTables.js"></script>
	<script src="js/lib/DataTables/js/dataTables.tableTools.js"></script>
	<link rel="stylesheet" type="text/css" href="js/lib/jquery-ui.css" />
	<link rel="stylesheet" type="text/css" href="js/lib/DataTables/css/jquery.dataTables.css" />
	<link rel="stylesheet" type="text/css" href="js/lib/DataTables/css/dataTables.tableTools.css" />
	<link rel="stylesheet" type="text/css" href="report.css" />
	<link rel="stylesheet" type="text/css" href="js/lib/slidebars.min.css" />
	
	<style>
	.navicon-line{
		width:25px;
		height:4px;
		border:1px solid #565656; 
		background-color:white; 
		margin:4px;
		}
	
	</style>
	<script>
	var reportType = document.URL.split("&")[1].substr(document.URL.split("&")[1].indexOf("=")+1);
	var dbindex = parseInt(document.URL.split("&")[2].substr(document.URL.split("&")[2].indexOf("=")+1));
	var username = document.URL.split("&")[3].substr(document.URL.split("&")[3].indexOf("=")+1);
	var mySlidebar;
	
	$(document).ready(function(){
		$('h2').append(reportType.replace(/%20/g, " ") +  ' Employment Report');
		mySlidebar = new $.slidebars();
		mySlidebar.slidebars.toggle();
	});
	
	$(function () {
		$('#jstree').jstree({	
			"core":{
				"check_callback" : true,
				"themes" : { "stripes" : true },
				"data" : [/* {
					"text" : "Aggregated Category",
					"state" : {"opened" : true},
					"id" : "aggCat1"
					}, */
					{"text" : "Agriculture","type" : "category", "id" : "agriculture_forestry_fishing_hunting"},
					{"text" : "Mining","type" : "category", "id" : "mining_quarrying_oil_gas_extraction"},
					{"text" : "Utilities","type" : "category", "id" : "utilities"},
					{"text" : "Construction","type" : "category", "id" : "construction"},
					{"text" : "Wholesale Trade","type" : "category", "id" : "wholesale_trade"},
					{"text" : "Information","type" : "category", "id" : "information"},
					{"text" : "Finance Insurance","type" : "category", "id" : "finance_insurance"},
					{"text" : "Real Estate","type" : "category", "id" : "real_estate_rental_leasing"},
					{"text" : "Professional Scientific Technical","type" : "category", "id" : "professional_scientific_technical_services"},
					{"text" : "Management ","type" : "category", "id" : "management_of_companies_enterprises"},
					{"text" : "Administrative Services","type" : "category", "id" : "administrative_support_waste_management_remediation_services"},
					{"text" : "Educational Services","type" : "category", "id" : "educational_services"},
					{"text" : "Health Care","type" : "category", "id" : "health_care_social_assistance"},
					{"text" : "Arts Entertainment","type" : "category", "id" : "arts_entertainment_recreation"},
					{"text" : "Accommodation Food","type" : "category", "id" : "accommodation_food_services"},
					{"text" : "Other Services","type" : "category", "id" : "other_services_except_public_administration"},
					{"text" : "Public Administration","type" : "category", "id" : "public_administration"},
					{"text" : "Manufacturing","type" : "category", "id" : "manufacturing"},
					{"text" : "Retail Trade","type" : "category", "id" : "retail_trade"},
					{"text" : "Transportation Warehousing","type" : "category", "id" : "transportation_warehousing"}
					]
			},
			/* "state" : { "key" : "demo2" }, */
			
			"types" : {
			  "default" : {
				"icon" : "js/lib/images/folder_closed-go.ico",
				"valid_children" : ["category"]
			  },
			  "category" : {
				"icon" : "js/lib/images/arrow-right.ico",
				"valid_children" : []
			  		  
				}
			},
			"contextmenu":{         
				"items": function($node) {
					var tree = $("#jstree").jstree(true);
					if (tree.get_type($node) == 'default'){
						return {
							"Rename": {
								"separator_before": false,
								"separator_after": false,
								"label": "Rename",
								"icon" : "js/lib/images/Rename.ico",
								"action": function (obj) { 
									tree.edit($node);
								}
							},                         
							"Remove": {
								"separator_before": false,
								"separator_after": false,
								"label": "Remove",
								"icon" : "js/lib/images/folder_delete.ico",
								"action": function (obj) { 
									if(tree.get_type($node) == 'category'){
									alert('You cannot delete categories')
									} else
									tree.delete_node($node);
								}
							}
						};	
					}else{
						return {
							"Rename": {
								"separator_before": false,
								"separator_after": false,
								"label": "Rename",
								"icon" : "js/lib/images/Rename.ico",
								"action": function (obj) { 
									tree.edit($node);
								}
							}
						};	
					}					
				}
			},
			"plugins" : [
						"dnd",
						"contextmenu",
						"sort",
						/* "state", */
						"types",
						"unique",
						"checkbox"
						]
		});
		
		$(document).on("dnd_stop.vakata", function (e, data) {
			$('#jstree').jstree(true).deselect_all();
		});
		
	});
	
	
	function toggleCheckbox(checkbox){	
		var tree= $('#jstree').jstree(true);
		if (checkbox.checked){
		tree.select_all();
		}else{
		tree.deselect_all();
		}	
	}
	
	function create() {
		var nodesList = [];
		var tree = $('#jstree').jstree(true);
		$('.jstree-node').each(function(){
		  if (tree.get_type($(this)) == 'default'){
			  var id   = $(this).attr('id');
			  var text = $(this).children('a').text();
			  nodesList.push(text);
			 }
		});
		
		var newName = " Aggregated Category";
		var counter = 1;
		if ($.inArray(newName, nodesList) < 0){
			tree.create_node("#",{ "text" : tree.get_string(newName), "state" : {"opened" : true} },'first',null,null);
		}else{			
			while ($.inArray(newName, nodesList) >= 0) {
				newName = " Aggregated Category " + counter++;
			}
			tree.create_node("#",{ "text" : tree.get_string(newName), "state" : {"opened" : true} },'first',null,null);		
		}
	}
	 
	function getTableHearders(){
		var nodesList = [];
		var tree = $('#jstree').jstree(true);
		$('.jstree-node').each(function(){
			if ((tree.get_parent($(this)) == '#' && tree.is_selected($(this))) || (tree.get_parent($(this)) == '#' && tree.get_type($(this)) == 'default')) {
				var id   = $(this).attr('id');
			  var text = $(this).children('a').text();
			  nodesList.push(text)
		    }
		});
		
		var y = "";
		nodesList.forEach (function (item, index, array){
			y += '<th>'+ item +'</th>'
		});
		return y;
	} 
	
	function clearReport(){
		document.getElementById('displayReport').innerHTML = "";
		$('#initialText').show();
	}

	</script>

	<!-- Beginning of the datatable -->
	<script type="text/javascript">
	
	function openReport(){	
		if ($('#jstree').jstree(true).get_selected()==""){
			alert('At least select 1 category');
			return 0;
		}
		
		// close slidebar
		mySlidebar.slidebars.close();
		
		
		$("#initialText").hide();
		document.getElementById('displayReport').innerHTML = "";
		var html = '<table id="Emp" class="display" align="center">';
		var tmp = 	'<tr><th id="an">Area ID <em title="ID conforming to the census data"><img src="images/tooltip.png" alt="tooltip"></em></th>'+
					'<th>Area Name<em title="County name"><img src="images/tooltip.png" alt="tooltip"></em></th>'+
					'<th>Population</em></th>'+
					'<th>Total Employment</em></th>'+
					'<th>Total Selected Employment</em></th>'+
					getTableHearders()+
					'<th>MetaData<em title="Report Metadata."><img src="images/tooltip.png" alt="tooltip"></em></th></tr>';
		html += '<thead>'+tmp+'</thead><tbody>';
		
		$.ajax({
			type: 'GET',
			datatype: 'json',
			url: '/TNAtoolAPI-Webapp/queries/transit/emp?&report='+reportType+'&dbindex='+dbindex+'&username='+getSession(),
			async: true,
			success: function(d){			
				// making a 2D array based on the selected categories and aggregated categories
				var tableContent = [];
				var rootList = [];
				var tree = $('#jstree').jstree(true);
				$('.jstree-node').each(function(){
				  if ((tree.get_parent($(this)) == '#' && tree.is_selected($(this))) || (tree.get_parent($(this)) == '#' && tree.get_type($(this)) == 'default')){
					  //var id   = $(this).attr('id');
					  //var text = $(this).children('a').text();
					  rootList.push(this);
					 }
				});
				
				tree.open_all();
				rootList.forEach (function (item, index, array){
					var parentID = $(item).attr('id');
					if (tree.is_parent(item)){						
						var children = tree.get_children_dom(item);
						//console.log('Children: ' + typeof children);
						var childrenIDs = [];
						$.each(children, function(ind,obj){
							//console.log($(obj).attr('id'));
							if (tree.is_selected(obj)){
								childrenIDs.push($(obj).attr('id'));
							}							
						});
						tableContent.push([parentID,childrenIDs]);
					}else{
						var childrenIDs = [parentID];
						tableContent.push([parentID,childrenIDs]);
					}
				});
				
				// making a hashmap of the query results.
				$.each(d.EmpDataList, function(i,item){
					var queryOutput = {};
					queryOutput['all_naics_sectors'] = item.all_naics_sectors;
					queryOutput['agriculture_forestry_fishing_hunting'] = item.agriculture_forestry_fishing_hunting;
					queryOutput['mining_quarrying_oil_gas_extraction'] = item.mining_quarrying_oil_gas_extraction;
					queryOutput['utilities'] = item.utilities;
					queryOutput['construction'] = item.construction;
					queryOutput['wholesale_trade'] = item.wholesale_trade;
					queryOutput['information'] = item.information;
					queryOutput['finance_insurance'] = item.finance_insurance;
					queryOutput['real_estate_rental_leasing'] = item.real_estate_rental_leasing;
					queryOutput['professional_scientific_technical_services'] = item.professional_scientific_technical_services;
					queryOutput['management_of_companies_enterprises'] = item.management_of_companies_enterprises;
					queryOutput['administrative_support_waste_management_remediation_services'] = item.administrative_support_waste_management_remediation_services;
					queryOutput['educational_services'] = item.educational_services;
					queryOutput['health_care_social_assistance'] = item.health_care_social_assistance;
					queryOutput['arts_entertainment_recreation'] = item.arts_entertainment_recreation;
					queryOutput['accommodation_food_services'] = item.accommodation_food_services;
					queryOutput['other_services_except_public_administration'] = item.other_services_except_public_administration;
					queryOutput['public_administration'] = item.public_administration;
					queryOutput['manufacturing'] = item.manufacturing;
					queryOutput['retail_trade'] = item.retail_trade;
					queryOutput['transportation_warehousing'] = item.transportation_warehousing;
					
					// Filling in the first 4 columns of the datatable
					html += '<tr><td>'+ item.id + '</a></td>'+
								'<td>' + item.name + '</td>'+
								'<td>' + numWithCommas(item.population) + '</td>'+
								'<td>' + numWithCommas(item.all_naics_sectors) + '</td>';
					
					// calculating the total employment selected and pushin to the datatable
					var totalSelectedEmp = 0;
					$('.jstree-node').each(function(){
						 if (tree.is_selected($(this)) && tree.get_type($(this)) == 'category'){
						 	totalSelectedEmp += queryOutput[$(this).attr('id')];
						 }
					});
					html += '<td>' + numWithCommas(totalSelectedEmp) + '</td>';
					
					// filling in the other columns of the datatable
					for (var index in tableContent){
						var summation = 0;
						tableContent[index][1].forEach(function(i, ind, arr){
							var node = $('#jstree').find("[id='"+i+"']");
							if (tree.is_selected(node)){
								summation += queryOutput[i];	
							}							
						});
						html+='<td>' + numWithCommas(summation) + '</td>';
					}
					html += '<td>' + 'd.metadata' + '</td></tr>'		
			});
		
		var html2 = '<tfoot>'+tmp+'</tfoot>';
		html +='</tbody>'+html2+'</table>';
		$('#displayReport').append($(html));
		
		var table = $('#Emp').DataTable({
			
			"bSort" : true,
			"paging": true,	
			"scrollX": true,
			"iDisplayLength": 15,
			"aoColumnDefs": [{"visible": false, "targets": [$('#Emp thead th').length - 1]}],
			"order": [[ 2, "des" ]],
			"dom": 'T<"clear">lfrtip',
	        "tableTools": {
	        	"sSwfPath": "js/lib/DataTables/swf/copy_csv_xls_pdf.swf",
	        	"sRowSelect": "os",
	        	"aButtons": [
	 						{"sExtends": "print", "sButtonText": "Print Report", "bFooter": false, "oSelectorOpts": {"filter": "applied"},
	 							"sMessage": ""
	 								+ " <input type='button' value='Return to regular view' onclick='TableTools.fnGetInstance(\"RT\")._fnPrintEnd({keyCode:27, preventDefault:function(){}})' />"},
	 		                
	 		                {
	 		                    "sExtends":    "collection",
	 		                    "sButtonText": "Export Report",
	 		                    "aButtons":    [ {"sExtends": "copy", "bSelectedOnly": true, "oSelectorOpts": {"filter": "applied"},
	 		                    				  "mColumns": 'visible'},
	 		                                     {"sExtends": "csv", "bSelectedOnly": true, "bFooter": false, "oSelectorOpts": {"filter": "applied"},
	 		                                      "mColumns": 'all'},
	 		                                     {"sExtends": "pdf", "bSelectedOnly": true, "bFooter": false, "oSelectorOpts": {"filter": "applied"},
	 		                                      "mColumns": 'all'} ]
	 		                } 
	 		            ]
	        }
			
		});
	 
	    //$('#CEmp_wrapper').css("width", "inherit");
	    $('#Emp_wrapper').css("margin", "auto");
		$("#Emp_length").remove();
	    $("#Emp_filter").insertBefore("#Emp_info");
	    $( ".dataTables_filter" ).css( "float", "left");
	    $( ".dataTables_filter" ).before( "<br>" );
		    }
		});
	}
	</script>
</head>

<body>
<div id="sb-site">	
	 <div class="container">
		<div class="headerL">
			<div class="sb-toggle-left navbar-left" style="float:left">
				<div class="navicon-line" style="background-color: #87F786"></div>
				<div class="navicon-line" style="background-color: #FFED28"></div>
				<div class="navicon-line" style="background-color: #FF7373"></div>
			</div>
			<h1 >Transit Network Analysis Tool Reports</h1>
		</div>	
			
		<div class="headerR">
			<select id='dbselect' onchange='dbchange()'></select>
			<input type="button" style="margin:3px" onclick="closebutton()" title="Close Report"  value="Close Report" class="button" />
			
		</div>
	</div>
	<div class="headerBL" style=" height:25px" >
		<h2 id='h2' style="margin-top:10px; margin-bottom:0px; text-indent: 45px"></h2>
		
	</div>
	<br>	
	 <div style="width:100%; height: 91.7vh; overflow:auto; float:left; border-style:groove; border-width:5px; backgroun-color: #E8E8E8">
		<p id="initialText" style="text-align: center; margin-top:150px; line-height: 70vh;" > <b>Choose categories and click "Create Report".</b></p>
		
		<!-- <table id="controls">
			<tr>
			  <td id="td1">
			  	<div class="headerBL"  >
				<h2 style="margin:0px;"></h2>
				</div>
			  </td>
			  
			  <td id="td3">
			  	<div class="headerBR" > 
			    			    			    	    	
		    	</div>
			  </td>
			</tr>
		</table> -->		
		
		
		<p id="displayReport" style="margin:5px; "><br></p>
		<br>
		<br>
		<div id="progressbar" style="width:40%;margin-left:27%"><div class="progress-label"></div></div>
	</div>
</div> 
	<div id="slidebar" class="sb-slidebar sb-left" data-sb-width="25%" style="height:100vh; width:23%; overflow:auto; border-style:groove; background-color:white; border-width:5px;">
		<button type="button" class="Button" onclick="create();" style="width:35%; margin-top:3px; height:30px; background-color: #87F786; border-color:#7CEA7B; border-radius: 6px;"><i class="glyphicon glyphicon-asterisk"></i>Create Category</button>
		<button type="button" class="Button" onclick="openReport();" style="width:35%; height:30px; background-color: #FFED28; border-color:#FFF99A; border-radius: 6px;"><i class="glyphicon glyphicon-asterisk"></i>Generate Report</button>
		<button type="button" class="Button" onclick="clearReport();" style="; width:27%; height:30px; background-color: #FF7373; border-color:#FF7373; border-radius: 6px;"><i class="glyphicon glyphicon-asterisk"></i>Clear Report</button>
		<br>
		<br>
		<div>
			<input type="checkbox" name="selecteAll" onchange="toggleCheckbox(this)" ><b>Select All</b><br>
		</div>
		<div id="jstree" class="demo" style="width:98%"></div>
		<br>
	</div>
		
</body>
</html>